name: Docker Multi-Arch Build with Build Cloud

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  DOCKER_USER: ${{ vars.DOCKER_USER }}
  DOCKER_PAT: ${{ secrets.DOCKER_PAT }}
  DOCKER_REGISTRY: adamrollogi
  BASE_IMAGE: base:latest
  PHP_IMAGE: php
  PHP_NGINX_IMAGE: php-nginx
  PHP_VERSIONS: "8.1 8.2 8.3 8.4"
  PLATFORMS: "linux/amd64,linux/arm64"

jobs:
  # Build Base Image First
  build-base:
    runs-on: ubuntu-latest
    steps:
      # Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_PAT }}

      # Set up Docker Buildx with Docker Build Cloud
      - name: Set up Docker Buildx with Build Cloud
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        with:
          version: "lab:latest"
          driver: cloud
          endpoint: "${{ env.DOCKER_USER }}/medusa"
          install: true

      # Build and Push Base Image
      - name: Build Base Image with Build Cloud
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          platforms: ${{ env.PLATFORMS }}
          context: ./alpine/base
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.BASE_IMAGE }}
          outputs: 'type=registry'
          provenance: true
          sbom: true

      # Attach VEX attestation to suppress known false positives
      - name: Attach VEX attestation to Base Image
        run: |
          docker scout attestation add \
            --file .vex/openvex.json \
            --predicate-type https://openvex.dev/ns/v0.2.0 \
            ${{ env.DOCKER_REGISTRY }}/${{ env.BASE_IMAGE }}

      # Trivy vulnerability scan
      - name: Run Trivy vulnerability scanner on Base Image
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # v0.34.0
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.BASE_IMAGE }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

  # Build PHP and PHP-NGINX Images after Base Image
  build-php:
    needs: build-base
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php_version: [8.1, 8.2, 8.3, 8.4]
    steps:
      # Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_PAT }}

      # Set up Docker Buildx with Docker Build Cloud
      - name: Set up Docker Buildx with Build Cloud
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        with:
          version: "lab:latest"
          driver: cloud
          endpoint: "${{ env.DOCKER_USER }}/medusa"
          install: true

      # Prepare Clean PHP Version
      - name: Prepare Clean PHP Version for PHP-NGINX Build
        run: echo "PHP_VERSION=$(echo ${{ matrix.php_version }} | tr -d '.')" >> $GITHUB_ENV

      # Build and Push PHP Image
      - name: Build PHP Image (${{ matrix.php_version }}) with Build Cloud
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          platforms: ${{ env.PLATFORMS }}
          context: ./alpine/php
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.PHP_IMAGE }}:${{ matrix.php_version }}
          build-args: |
            PHP_VERSION=${{ env.PHP_VERSION }}
          outputs: 'type=registry'
          provenance: true
          sbom: true

      # Attach VEX attestation to suppress known false positives
      - name: Attach VEX attestation to PHP Image (${{ matrix.php_version }})
        run: |
          docker scout attestation add \
            --file .vex/openvex.json \
            --predicate-type https://openvex.dev/ns/v0.2.0 \
            ${{ env.DOCKER_REGISTRY }}/${{ env.PHP_IMAGE }}:${{ matrix.php_version }}

      # Trivy vulnerability scan for PHP Image
      - name: Run Trivy vulnerability scanner on PHP Image (${{ matrix.php_version }})
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # v0.34.0
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.PHP_IMAGE }}:${{ matrix.php_version }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

      # Prepare Clean PHP Version
      - name: Prepare Clean PHP Version for PHP-NGINX Build
        run: echo "PHP_VERSION=$(echo ${{ matrix.php_version }} | tr -d '.')" >> $GITHUB_ENV

      # Build and Push PHP-NGINX Image
      - name: Build PHP-NGINX Image (${{ matrix.php_version }}) with Build Cloud
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          platforms: ${{ env.PLATFORMS }}
          context: ./alpine/php-nginx
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.PHP_NGINX_IMAGE }}:${{ matrix.php_version }}
          build-args: |
            PHP_IMAGE_TAG=${{ matrix.php_version }}
            PHP_VERSION=${{ env.PHP_VERSION }}
          outputs: 'type=registry'
          provenance: true
          sbom: true

      # Attach VEX attestation to suppress known false positives
      - name: Attach VEX attestation to PHP-NGINX Image (${{ matrix.php_version }})
        run: |
          docker scout attestation add \
            --file .vex/openvex.json \
            --predicate-type https://openvex.dev/ns/v0.2.0 \
            ${{ env.DOCKER_REGISTRY }}/${{ env.PHP_NGINX_IMAGE }}:${{ matrix.php_version }}

      # Trivy vulnerability scan for PHP-NGINX Image
      - name: Run Trivy vulnerability scanner on PHP-NGINX Image (${{ matrix.php_version }})
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # v0.34.0
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ env.PHP_NGINX_IMAGE }}:${{ matrix.php_version }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

      # Verify Build Results
      - name: Verify Built Images
        run: |
          docker buildx imagetools inspect ${{ env.DOCKER_REGISTRY }}/${{ env.PHP_IMAGE }}:${{ matrix.php_version }}
          docker buildx imagetools inspect ${{ env.DOCKER_REGISTRY }}/${{ env.PHP_NGINX_IMAGE }}:${{ matrix.php_version }}
